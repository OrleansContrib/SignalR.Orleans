name: Build

on:
  push:
    branches:
      - master
      - '*.x'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Print environment versions
        run: |
          NPM_V=$(npm -v)
          echo npm version':' $NPM_V
          DOTNET_CLI_V=$(dotnet --version)
          echo dotnet cli version':' $DOTNET_CLI_V

      - name: Set up .NET Core
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.0.x

      - name: dotnet restore
        run: dotnet restore

      - name: dotnet build
        run: dotnet build -c Release

      - name: Test
        run: npm test

      - name: Check if branch is publishable
        run: |
          if ! ([ ${{ github.ref }} = "refs/heads/master" ] || [[ "${{ github.ref }}" =~ ^(([0-9]+|\.)+x)$ ]]); then
            echo "Non-publishable branch; finishing build..."
            exit 1
          fi

      - name: Publish NuGet
        run: |
          export SKETCH7_NUGET_API_KEY=${{ secrets.NUGET_KEY }}

          npm run publish:dev